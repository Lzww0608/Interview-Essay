# Q103. redis如何实现分布式锁

分布式锁是一种用于在分布式系统中控制对共享资源（如数据库、文件、缓存等）访问的机制，以确保多个进程或节点不会同时对同一资源进行修改，从而避免数据不一致或竞争条件的问题。它类似于传统的锁机制，但用于跨多个独立的系统或服务之间。

利用 Redis 的 `SETNX`（Set if Not Exists）命令和过期时间来实现。客户端尝试使用 `SETNX` 命令创建一个键，如果成功则获得锁。同时设置锁的过期时间，以防止死锁。

### 1. 获取锁

使用 `SET` 命令的扩展功能来获取锁：

```shell
SET key value NX PX timeout
```

- `key`：锁的标识，通常是业务相关的唯一字符串。
- `value`：一个唯一的标识符（如 UUID），用于区分是谁持有了锁。
- `NX`：表示只有在键不存在时才设置键，确保操作的原子性。
- `PX timeout`：设置过期时间，以毫秒为单位，防止死锁。

示例：

```shell
SET lock:resource_name unique_value NX PX 30000
```

如果命令返回 `OK`，说明锁获取成功；如果返回 `nil`，说明锁已经被其他客户端持有。

### 2. 释放锁

释放锁时需要确保是持有锁的客户端才可以删除该锁。为此，需要使用 Lua 脚本保证操作的原子性：

```lua
if redis.call("GET", KEYS[1]) == ARGV[1] then
    return redis.call("DEL", KEYS[1])
else
    return 0
end
```

- `KEYS[1]`：锁的键。
- `ARGV[1]`：唯一标识符，确保只有持有锁的客户端才可以释放锁。

### 3. 锁超时和自动续期

锁的有效期通过 `PX timeout` 选项设置，防止死锁的产生。如果业务逻辑处理时间可能超过锁的超时时间，可以实现锁的自动续期机制：

- 定期检查并续期：通过客户端轮询或后台线程在锁快到期时调用 `PEXPIRE` 或更新锁的过期时间。
- 使用 Redisson 等客户端库：这些库提供了自动续期的功能，简化了分布式锁的使用。

### 4. Redis 分布式锁的注意事项

- **锁的原子性**：Redis 使用单个 `SET NX PX` 命令保证获取锁的原子性。
- **锁的独占性**：通过唯一值区分不同的客户端持有锁的情况。
- **锁的可用性**：锁有过期时间，防止客户端崩溃或失联导致的死锁。
- **锁的安全释放**：通过对比唯一标识符确保只有锁的持有者才能释放锁。



### Redlock 的工作原理

Redlock 算法的核心思想是使用多个独立的 Redis 实例来获取锁，从而确保系统的可靠性和可用性。以下是 Redlock 的工作步骤：

1. **获取锁的客户端** 需要在 **多个（建议是奇数个，例如 5 个）Redis 实例** 中尝试加锁。
2. 客户端会生成一个全局唯一的随机值，并使用这个值和一个设置的过期时间（TTL）去请求每个 Redis 实例来设置锁。设置锁的操作是原子的，即使用 `SET resource_name random_value NX PX ttl`，其中：
   - `NX` 表示只有在键不存在的情况下才进行设置。
   - `PX ttl` 表示设置过期时间，以毫秒为单位。
3. 客户端会尝试**在尽可能短的时间内**（例如少于锁的 TTL 时间）向每个 Redis 实例请求锁。
4. 当且仅当客户端在大多数（例如 5 个实例中的至少 3 个）Redis 实例中都成功设置了锁时，才认为锁获取成功。
5. 如果获取锁失败（例如没有在足够多的 Redis 实例中获得锁），客户端会在所有实例中释放锁（如果获取成功的部分）。
6. **锁的释放**：释放锁时，客户端必须向每个 Redis 实例发送一个 Lua 脚本，通过检查锁的持有者（随机值）来确保只有锁的持有者才能释放锁，从而防止其他客户端错误地释放锁。

![1725284078312](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1725284078312.png)

### Redlock 的优点

- **高可用性**：通过多个 Redis 实例，Redlock 提供了较高的容错能力。
- **自动过期**：锁自动过期机制可以防止死锁。
- **简单实现**：基于 Redis 的原子操作和 Lua 脚本，可以较简单地实现。

### Redlock 的缺点

- **网络分区**：在网络分区的情况下，可能出现分布式一致性问题。
- **系统时钟依赖**：由于依赖于锁的 TTL，Redlock 假设各个节点的时钟同步，这在分布式系统中并不是总能保证的。
- **性能影响**：需要向多个 Redis 实例发起请求，性能相对单实例锁会有所下降。

![1725284092321](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1725284092321.png)

![1725284112270](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1725284112270.png)