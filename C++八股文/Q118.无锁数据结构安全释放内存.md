# Q118.无锁数据结构安全释放内存

**Hazard Pointers 的工作原理：**

1. **Hazard Pointer 数组：**  每个线程维护一个固定大小的数组，称为 Hazard Pointer 数组。数组中的每个元素可以存放一个“危险指针”。
2. **声明 Hazard Pointer：**  当线程准备访问一个共享对象（例如，从跳表节点读取 `next` 指针）时，它会从自己的 Hazard Pointer 数组中取出一个空闲位置，并将想要访问的指针地址 **原子地** 写入该位置，声明自己“正在使用”这个指针，这个指针就成为了一个“危险指针”。
3. **读取数据：**  线程现在可以安全地读取它声明为 Hazard Pointer 的指针所指向的数据。
4. **取消 Hazard Pointer：**  当线程完成对共享对象的访问后，它需要 **清除** 之前设置的 Hazard Pointer，表示不再使用该指针。
5. **节点退休 (Retire)：** 当一个线程想要删除或释放一个节点时（例如，跳表节点从链表中移除后），它不能立即释放内存。而是将这个待释放的节点放入一个 **退休列表 (Retire List)**。
6. **安全回收扫描：**  系统需要定期（或在退休列表达到一定大小时）进行 **安全回收扫描**。扫描过程如下：
   - 遍历退休列表中的每个待释放节点。
   - 对于每个待释放节点，遍历 **所有线程** 的 Hazard Pointer 数组。
   - 检查是否存在任何 Hazard Pointer 指向 **当前待释放节点**。
   - **如果没有任何 Hazard Pointer 指向该节点，则可以安全地释放该节点的内存。**
   - 如果仍然有 Hazard Pointer 指向该节点，则说明还有线程正在访问该节点，该节点 **不能被释放**，需要等待下一次扫描。