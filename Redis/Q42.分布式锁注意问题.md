# Q42.分布式锁注意问题

Redis实现分布式锁时需要注意以下几个关键的问题：

1. **原子性**: 在设置锁时，我们需要确保一旦一个请求获取了锁，其他的请求要么处于等待状态要么就去做其他的事情。Redis提供的命令

   ```
   SET key value NX PX milliseconds
   ```

   可以保证这个过程的原子性，代表只有当key不存在时，我们才设置value. PX参数指这把锁会在指定的时间后(毫秒)自动删除。

2. **锁超时**: 很重要的一点是，我们需要防止一个客户端在获取一个锁后因为某些原因(比如程序崩溃)导致无法释放这把锁。为了防止其他的客户端永远等待下去，我们需要为这把锁设一个超时时间。

3. **锁续期**: 对于一些预计会长时间持有锁的操作，我们可能需要实现一个自动续期的机制，防止在任务执行过程中锁过期被其他客户端获取。

4. **谨慎处理解锁过程**: 解锁的时候也需要注意，确保只有获取到锁的客户端才能解锁，不能由别的客户端解锁。可以存储一个随机的value，每个客户端解锁比对value是否为自己，相同才执行解锁。

5. **加锁失败的处理**: 在锁已经被其他客户端持有的情况下，加锁请求会失败，此时需要实现重试机制或者直接失败。

举个简单的例子，比如在秒杀系统中，为了保证商品的一致性，我们需要在用户下单的时候对商品库存进行加锁，防止多个请求同时修改库存导致超卖现象. 在这种场景下，我们就需要通过Redis来实现分布式锁，而且需要处理以上所述的各种情况。