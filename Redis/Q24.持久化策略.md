# Q24.持久化策略

Redis通过使用不同的数据持久化策略来在数据安全性和性能之间进行权衡，包括RDB和AOF（Append Only File），以及二者的组合使用。

1. RDB持久化可以定期将当前的数据快照（snapshot）写入磁盘。比如你可以设置Redis每隔5分钟就把当前内存中的数据生成一次快照，存入硬盘。但这种方式可能会造成最近几分钟内的数据丢失。举例来说，假设你的系统在10:00做了一次快照，在10:05时 Redis服务器突然宕机，那么你就会丢失10:00到10:05这五分钟内的数据。
2. AOF（Append Only File）持久化每当数据改变时都会将命令追加到AOF文件中。当Redis重新启动时，会通过重新执行AOF文件中的命令来恢复数据。AOF方式通过记录每一条修改数据库的命令来保证数据的强一致性，即使在系统崩溃的情况下，数据的确保也仍然有保障。在默认配置中，Redis每秒钟fsync一次AOF文件，即使发生故障也只会丢失一秒钟的数据。
3. RDB和AOF的组合使用。为了同时拥有RDB和AOF各自的优点，实际中我们也可以同时开启两者。数据恢复首选AOF，当AOF出问题时，再使用RDB恢复。这样既保证了数据的安全性也保证了性能。

通过灵活地配置RDB的快照频率以及AOF的写入硬盘频率，Redis可以实现既保证数据安全性也兼顾性能的效果。默认情况下Redis已经对这两者进行了较好的配置，当然根据你的实际业务需求，你也可以自行进行修改。在数据安全性要求极高的情况下，应该优先保证数据安全性。在性能要求极高的情况下，可以适当地降低数据安全性的要求，以此来提高性能。

例如，一个用户会话状态存储可以选择RDB做持久化，即使Redis崩溃重启，丢失几分钟的用户状态影响也是相对较小。而在支付系统等对数据强一致性要求非常高的场合，则需要优先使用AOF做持久化，减少由于Redis崩溃导致的数据损失。