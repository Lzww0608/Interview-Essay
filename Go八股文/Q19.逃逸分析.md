# Q19.逃逸分析

在Go语言中，逃逸分析(Escape Analysis)是一种编译器优化技术，用于确定变量是应该分配在堆上还是在栈上。这对程序的性能有显著的影响，因为栈上资源的分配速度和释放速度要比堆上快得多，同时堆上的内存管理也更加简单。



## 基本概念

逃逸分析的主要目的是检测局部变量的生命周期是否超出了函数的作用范围。如果一个局部变量在函数返回后仍然需要使用，那么他就会**逃逸**到堆上，否则该变量可以分配到栈上。

逃逸的具体原因可能有很多，比如：

- 将局部变量指针返回
- 全局变量赋值为局部变量的地址
- 将局部变量的地址赋值给了函数的参数
- 将局部变量的地址保存到了数据结构中等

下面是一个逃逸的简单例子：

```go
package main

func main() {
    example()
}

func example() *int {
    value := 42
    return &value
}
```

在这个例子中，局部变量`value`在函数中声明并且初始化。由于函数返回的是`value`的指针，这意味着`value`在函数返回之后依然可以被使用。因为`value`被标记为逃逸，并被分配到堆上。



## 优点：

**性能影响**：栈上的内存分配和释放速度非常快，而堆上的内存管理涉及更多的开销（如垃圾回收）。通过优化变量的分配位置，可以显著提升程序的性能。

**内存管理**：在栈上分配的内存会在函数返回时自动释放，而在堆上分配的内存则需要垃圾回收器来管理，增加了系统的负担。

我们可以在编译的时候加上`-gcflags="-m"`标志来查看编译器逃逸分析的结果，例如：`go build -gcflags="-m" main.go`。这将显示出每个变量是否逃逸，以及为什么逃逸。上述例子的结果如下：

![1719222910711](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1719222910711.png)

