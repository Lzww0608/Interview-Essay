# Q7. 简述Go的垃圾回收机制

`Go`的`GC(Garbage Collection, 垃圾回收)`机制主要是用来自动释放不再被程序使用的内存，以防止内存泄漏。`Go`的垃圾回收是**并发**的，也就是说，它在主程序运行的同时进行垃圾回收。



### 1. 标记清除(Mark and Sweep)

`Go`的垃圾回收器主要使用的是标记清除算法。这个算法包含两个阶段：**标记阶段和清除阶段**。在标记阶段，垃圾回收期会从**根对象**(root object, 全局变量、栈上的变量等)开始，找出所有的可达的对象，并进行标记。在清除阶段，垃圾回收器会遍历堆中的所有对象，清除那些没有被标记的对象，也就是不可达的对象。



### 2. 并发执行(Concurrent Execution)

`Go`语言的的垃圾回收器并不会在运行时停止所有的用户级线程(即协程)。相反，它使用了一种称为三色标记清除(Tri-color Mark and Sweep)的算法，使得垃圾回收器可以在主程序运行的同时进行垃圾回收。在这个方法中，对象被分为三种颜色：

- **白色**：表示对象可能是垃圾，即未被确认是否可达。
- **灰色**：表示对象已被标记为存活，但其引用的对象还未完全检查。
- **黑色**：表示对象及其所有引用都已经被检查，确认为非垃圾。

这种方式可以减少程序的暂停时间，提高程序运行效率。



### 3. 写屏障(Write Barrier)

在并发标记阶段，由于用户程序和垃圾回收器是同时运行的， 用户程序可能会修改堆中的数据。为了在这种情况下保证垃圾回收的正确性，`Go`的垃圾回收器使用了写屏障技术。写屏障会在用户程序尝试写入一个指针时触发，更新垃圾回收器的标记信息。



### 4. 内存分配

`Go`的内存管理器与垃圾回收器紧密结合，使用了T型分配器（T型是针对不同大小的对象优化的内存分配策略）。小对象通常在连续的内存块中分配，这称为“span”。这种方式有助于提高内存分配的效率并减少碎片。



### 5. 垃圾回收调度(GC Pacing)

Go的垃圾回收周期由内存增长和分配活动触发。如果内存分配速度快于回收速度，回收器会更频繁地运行，以确保内存使用效率和程序性能。