# Q43.消息可靠性方案

Kafka保障消息不丢失的策略主要包括以下几种：

1. **持久化机制**：Kafka通过将消息持久化到磁盘来实现数据可靠存储。具体来说，Kafka采用异步批量刷新磁盘的方式，按照一定的消息量和时间间隔刷盘存储消息。在刷盘之前，消息会先被写入到内存中的PageCache中，以便更快地被读取和写入。这种机制可以减少因系统崩溃导致的数据丢失问题。
2. **副本机制**：Kafka提供了副本机制来确保数据的可靠性和容错性。每个分区都有一个leader和多个副本，其中leader主要负责事务类型的请求，而follower则负责同步leader上面的数据。当leader出现故障时，Kafka可以从follower中选举一个新的leader，以保证数据的可用性和一致性。
3. **Acks机制**：Kafka提供了一个acks参数来控制生产者何时等待来自broker的响应。当acks=0时，生产者不需要等待broker的响应，这可能会存在数据丢失的风险；当acks=1时，生产者会在broker的leader和Partition收到消息后等待确认，但若leader和Partition出现故障，可能会存在数据丢失的风险；当acks=-1时，生产者会在broker的leader和Partition收到消息后等待确认，同时会等待ISR列表中的follower同步完成后再返回确认，这样可以保证数据不丢失。
4. **异步回调**：Kafka还提供了异步回调的机制来监听消息的发送状态。如果发送时报错，Kafka会再次调用发送方法重新发送消息。

综上所述，Kafka通过持久化机制、副本机制、acks机制以及异步回调机制来共同保障消息的可靠性。