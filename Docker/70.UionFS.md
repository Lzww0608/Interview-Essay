# 70.UionFS

Docker 镜像使用了一种名为联合文件系统（UnionFS）的技术，它允许将多个文件系统层合并在一起，形成一个单一的文件系统。每个 Docker 镜像都是由多个只读层构成的，每个层都包含了该镜像相对于基础镜像所做的更改。当容器运行时，Docker 会将这些只读层与一个可写的容器层结合起来，形成一个完整的文件系统。这样，Docker 可以高效地存储和共享镜像，同时保持操作系统的轻量级。

### 详细讲解与拓展

1. 联合文件系统的工作原理：
   - 联合文件系统允许多个文件系统层叠加在一起，每个层只记录相对于前一个层的差异。这意味着，每个镜像层都只包含它与父层相比的修改，极大地节省了存储空间。

- 当 Docker 镜像被创建时，它会通过层叠多个只读层来形成最终的镜像。每个层都是只读的，容器运行时，它会基于这些只读层创建一个可写的容器层，用于存储容器内的更改。

1. 层的结构：
   - Docker 镜像由多个层组成：
     - **基础镜像层**：每个 Docker 镜像都建立在某个基础镜像之上，如 `ubuntu`、`alpine` 等。
     - **应用层**：镜像中的每一层都可能包含某个应用程序或操作系统的一部分。
     - **最终镜像**：所有这些层叠加后形成了一个完整的镜像。每一层都可以被其他镜像共享。
2. 只读层和可写层：
   - **只读层**：镜像的每一层都是只读的。这个层不会被修改，因此多个容器可以共享同一层，以节省空间。
   - **可写层**：容器在运行时会添加一个可写层，用于保存容器的运行状态和对文件系统的更改。这个层只属于该容器，每次启动容器时会生成一个新的可写层。
3. 优势：
   - **空间节省**：联合文件系统通过共享镜像层来节省存储空间。每个镜像层只存储增量内容，因此多个容器可以共享同一镜像层，避免重复存储相同的文件。
   - **高效性**：创建新镜像时，无需复制整个文件系统，只需添加一个新层，保存相对于前一层的差异。这使得镜像构建和分发更加高效。
4. 常见的联合文件系统类型：
   - Docker 支持多种联合文件系统（UnionFS），其中常见的有：
     - **OverlayFS**：这是现代 Linux 系统上推荐的联合文件系统，它提供了高效的 Copy-on-Write（COW）特性。
     - **AUFS**：较老的联合文件系统，虽然不再是默认选项，但它曾经是 Docker 早期使用的联合文件系统。
     - **Btrfs**：Btrfs 提供更复杂的文件系统管理特性，适用于需要强大功能的环境。
     - **ZFS**：也是一种支持快照和层叠的文件系统，适用于高性能和高可靠性的环境。
5. 镜像构建过程中的联合文件系统：
   - 当你构建 Docker 镜像时，Docker 会创建一系列的层，并通过联合文件系统将它们合并成一个完整的镜像。每个层都表示一个文件系统的增量变化，当容器运行时，Docker 会将这些层合并并创建一个可写的容器层。
6. 容器的运行时行为：
   - 在容器启动时，联合文件系统将每个镜像层与可写层合并。用户对文件的任何修改都会被写入到可写层，而其他层依然保持不变。这使得每个容器都可以在不影响其他容器的情况下修改文件。

**总结**：Docker 镜像使用联合文件系统（UnionFS）来将多个只读层和一个可写层合并，形成一个完整的文件系统。这样可以高效地存储和共享镜像，同时节省存储空间。联合文件系统的优点包括节省空间、高效的镜像构建和分发、以及支持快速创建和修改容器。