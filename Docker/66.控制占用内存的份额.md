# 66.控制占用内存的份额

在 Docker 中，可以通过以下参数来控制容器占用的内存资源：

1. `--memory`：限制容器的内存使用上限。如果容器的内存使用超过这个限制，它会被强制停止并可能被重启。你可以设置绝对值（例如512m或2g），限制容器最大使用的内存量。

   ```bash
   docker run -d --memory 512m mycontainer
   ```

2. `--memory-swap`：控制容器的内存和交换区（swap）总共享量。该参数指定了容器可以使用的交换空间大小。通常，`--memory-swap`设置的值应该大于或等于`--memory`设置的值。比如，

   ```
   --memory=512m --memory-swap=1g
   ```

   意味着容器最多可以使用 512MB 内存和 512MB 的 swap。

   ```bash
   docker run -d --memory 512m --memory-swap 1g mycontainer
   ```

3. `--oom-kill-disable`：当容器的内存超出限制时，Docker 默认会终止该容器并生成 OOM（Out of Memory）错误。如果不希望容器被杀死，可以禁用 OOM 杀死功能。

   ```bash
   docker run -d --memory 512m --oom-kill-disable mycontainer
   ```

4. `--memory-swappiness`：控制容器的内存交换倾向（swap behavior）。它的取值范围是 0 到 100，越小表示容器倾向于使用物理内存而不是交换空间。默认值为 60。

   ```bash
   docker run -d --memory-swappiness 10 mycontainer
   ```

### 详细讲解与拓展

1. `--memory`：

   - 该选项用于设置容器的最大内存限制。如果容器尝试分配超过这个限制的内存，Docker 会杀掉该容器，并生成一个 OOM（Out of Memory）错误。
   - 容器的内存限制可以通过绝对值来指定，如 `512m`（512MB）或 `2g`（2GB）。
   - 需要注意的是，`--memory` 设置的是容器的最大内存容量，而容器本身可能需要根据业务负载来适当配置内存。

   示例：限制容器使用最多 1GB 内存

   ```bash
   docker run -d --memory 1g mycontainer
   ```

2. `--memory-swap`：

   - `--memory-swap` 是内存和交换空间的联合配置。它限制了容器使用内存和 swap 的总和。一般来说，如果 `--memory-swap` 设置小于 `--memory`，则容器无法使用 swap。交换空间是为了容器内存需求较高时可以暂时从硬盘交换出来使用。
   - 例如，`--memory=1g --memory-swap=2g` 允许容器最多使用 1GB 的物理内存和最多 1GB 的交换空间，总共 2GB 的内存。
   - 如果你希望容器只使用物理内存而不使用交换空间，可以将 `--memory-swap` 设置为与 `--memory` 相同的值或设置为 0。

3. `--oom-kill-disable`：

   - 在 Docker 中，OOM（Out of Memory）是当容器超出内存限制时，容器会被杀死。如果容器在高负载情况下经常出现内存溢出的情况，可以通过 `--oom-kill-disable` 禁用该功能。
   - 但是，禁用 OOM 杀死功能后，容器可能会变得不稳定，甚至系统本身的内存也会受到影响。因此，除非你有特殊需求，否则最好保持默认设置，允许容器在内存过载时被终止。

4. `--memory-swappiness`：

   - 该参数控制容器在内存不足时使用交换空间的优先级。如果 `--memory-swappiness` 设置为较高的值（接近 100），容器会更倾向于使用交换空间而不是物理内存。相反，如果设置为较低的值（接近 0），容器将尽量避免使用交换空间，优先使用物理内存。
   - 这个选项对性能优化有帮助，特别是在内存压力较大的情况下。适当调整它可以减少交换空间的使用，保证容器的内存性能。

5. 容器内存管理的最佳实践：

   - **适当设置内存限制**：对于每个容器，根据其运行的工作负载设置合理的内存限制。避免设置过大的内存限制，这样会浪费主机资源，造成资源竞争；同时，也要确保设置的内存足够支撑容器的正常运行。
   - **使用监控工具**：使用 `docker stats` 或其他监控工具监控容器的内存使用情况。这样可以及时发现内存占用过高的容器，避免 OOM 错误。
   - **合理配置交换空间**：对于内存较为紧张的应用，适当配置交换空间可以帮助容器更好地应对突发的内存需求。你可以根据容器的内存需求，设置合理的 `--memory` 和 `--memory-swap` 值，确保容器有足够的资源进行容错处理。
   - **避免在单个容器中运行多个应用**：如果在同一个容器中运行多个进程或应用，会增加内存管理的复杂性，容易导致容器内存过载。最好遵循 “一个容器一个应用” 的设计原则。

6. 容器内存泄漏与性能优化：

   - 容器在运行时可能会出现内存泄漏，尤其是在持续运行的应用中。如果容器的内存占用不断增加而没有释放，需要分析容器内运行的应用程序是否存在内存泄漏。
   - 可以通过 `docker stats` 查看内存的实时使用情况，定位问题容器，并检查应用日志或进行性能调优。

**总结**：要控制 Docker 容器的内存使用，可以通过 `--memory`、`--memory-swap`、`--oom-kill-disable` 和 `--memory-swappiness` 等参数来进行内存资源的限制和优化。合理的内存管理可以确保容器资源的高效利用，避免内存过载和系统不稳定。