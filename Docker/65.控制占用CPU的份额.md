# 65.控制占用CPU的份额

在 Docker 中，控制容器占用 CPU 资源的方式主要通过 `--cpu-shares`、`--cpus` 和 `--cpu-set` 等参数来设置。以下是一些常用的 CPU 资源控制方法：

1. `--cpu-shares`：控制容器的 CPU 配额，默认值为 1024。这个值用于设置容器的相对 CPU 权重。如果容器的 CPU 使用量超过其份额，它将与其他容器竞争 CPU 资源。例如，设置为 512 的容器将获得比设置为 1024 的容器更少的 CPU 资源。

   ```bash
   docker run -d --cpu-shares 512 mycontainer
   ```

2. `--cpus`：限制容器可以使用的 CPU 数量，支持小数。比如，

   ```
   --cpus=2.5
   ```

   表示容器最多使用 2.5 个 CPU 核心。这个参数可以精确控制容器的 CPU 使用限制。

   ```bash
   docker run -d --cpus 2.5 mycontainer
   ```

3. `--cpuset-cpus`：指定容器可以运行的 CPU 核心。通过该选项，你可以将容器绑定到一个或多个特定的 CPU 核心上。例如，

   ```
   --cpuset-cpus="0,1"
   ```

   表示容器只能在 CPU 核心 0 和 1 上运行。

   ```bash
   docker run -d --cpuset-cpus="0,1" mycontainer
   ```

### 详细讲解与拓展

1. `--cpu-shares`：

   - 这个参数定义了容器在多容器环境中竞争 CPU 资源时的相对优先级。容器的默认 `--cpu-shares` 值为 1024，如果你将某个容器的 `--cpu-shares` 设置为更高的值，它会获得更多的 CPU 时间。注意，`--cpu-shares` 并不会限制容器的最大 CPU 使用量，而是用于定义容器与其他容器共享 CPU 资源的优先级。

   - 例如，两个容器同时运行：

     - 容器 A 使用 `--cpu-shares 1024`（默认值）
     - 容器 B 使用 `--cpu-shares 512`

     如果这两个容器同时运行，容器 A 将获得两倍于容器 B 的 CPU 时间。

2. **--cpus**：

   - `--cpus` 参数可以用来限制容器使用的 CPU 核心数。这个参数不仅仅是用来设置权重，它还可以硬性限制容器最多可以使用的 CPU 数量。例如，如果你设置 `--cpus=1.5`，容器最多只能使用 1.5 个 CPU 核心的计算资源。如果容器负载过重，超出这个限制的部分将被限制，防止容器过度占用资源。
   - `--cpus` 提供了一种更精确的控制方式，适用于你想要确保容器占用一定数量的 CPU 核心时。

3. `--cpuset-cpus`：

   - `--cpuset-cpus` 允许你将容器绑定到指定的 CPU 核心上。比如，`--cpuset-cpus="0,1"` 将容器绑定到 CPU 0 和 CPU 1 上，这样就能确保容器只会使用这两个特定的核心。
   - 这对于资源密集型应用非常有用，尤其是当你希望控制容器在多个 CPU 核心之间的负载分配时。通过这种方式，你可以优化系统性能，并避免容器过度占用系统资源。

4. `--cpu-period` 和 `--cpu-quota`：

   - 除了上述参数，Docker 还提供了 `--cpu-period` 和 `--cpu-quota` 参数，可以进一步控制 CPU 使用量。这两个参数通常一起使用来限制容器的 CPU 时间配额。

   - `--cpu-period` 用来定义一个时间周期（单位为微秒），默认值为 100000（即 100 毫秒）。

   - `--cpu-quota` 用来定义容器在每个周期内能够使用的 CPU 时间，单位为微秒。例如，如果你将 `--cpu-period` 设置为 100000，`--cpu-quota` 设置为 50000，那么容器将在每个 100 毫秒周期内最多使用 50 毫秒的 CPU 时间。

   - 示例：

     ```bash
     docker run -d --cpu-period=100000 --cpu-quota=50000 mycontainer
     ```

     这个命令将限制容器在每 100 毫秒内最多只能使用 50 毫秒的 CPU 时间，相当于限制容器只能使用 50% 的 CPU 资源。

5. 多容器资源管理：

   - 如果你运行多个容器并且希望它们能够公平地共享系统资源，可以结合使用 `--cpu-shares` 和 `--cpus` 参数。合理设置这些参数可以确保各个容器的资源分配更加公平，从而避免某些容器占用过多的 CPU 资源，影响到其他容器的运行。

6. 监控容器的 CPU 使用情况：

   - 你可以使用 `docker stats` 命令来监控容器的实时 CPU 使用情况。

   ```bash
   docker stats
   ```

   这将显示所有正在运行的容器的资源使用情况，包括 CPU、内存、网络等。

**总结**：要控制 Docker 容器的 CPU 资源使用，可以通过参数如 `--cpu-shares`、`--cpus`、`--cpuset-cpus` 和 `--cpu-period`/`--cpu-quota` 来限制容器占用的 CPU 份额。最佳实践是根据容器的实际需求设置合适的资源限制，避免容器占用过多资源影响系统的稳定性与性能。